<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>The RoboEarth Cloud Engine - HTML Client</title>
<style type='text/css'>
.mask{
  position: relative;
  overflow: hidden;
  margin: 0px auto;
  width: 80%;
  background-color: #ffffff
}
.header{
  float: left;
  width: 100%;
  height: 30px;
  background-color: #ffffff;
  padding:5px
}
.colleft{
  position: relative;
  width: 100%;
  right: 50%;
  background-color: #ffffff
}
.col1{
  position: relative;
  overflow: hidden;
  float: left;
  width: 48%;
  left: 101%;
  background-color: #ffffff
}
.col2{
  position: relative;
  overflow: hidden;
  float: left;
  width: 48%;
  left: 3%;
  background-color: #ffffff
}
.footer{
  float: left;
  width: 100%;
  background-color: #ffffff;
  padding: 25px
}
body {
  padding: 0px;
  margin: 0px;
  font-size: 90%;
  background-color: #ffffff
}
</style>

<script type="text/javascript" src="rce_cmds.js"></script>
<script type="text/javascript" src="jquery-1.7.2.js"></script>
<script type="text/javascript">

var wsuri = "ws://localhost:9000/";
var webSocket = null;

var receivedMsgNum = 0;

//generate dummyID for the robot
var robotUniqueID = "robotUniqueID";

var robotStatus = "Not connected";
var containerID = "--";

window.onload = function() {
	document.getElementById('wsuri').value = wsuri; //default value
	
	// Check for the file API support.
	if (window.File && window.FileReader && window.FileList && window.Blob) {
  	console.log('Info: All the File APIs are supported.');
	} else {
  	console.log('Warn: The File APIs are not fully supported in this browser.');
	}
	
	//file event listener
	document.getElementById('files').addEventListener('change', handleFileSelect, false);
	
	//image canvas
	canvas = document.getElementById("myCanvas");
	context = canvas.getContext("2d");
	imageObj = new Image();
	imageObj.onload = function() {
		context.drawImage(imageObj, 0, 0);
	}
	
	//load and add debug commands 
	var select = document.getElementById('cmd_list');
	for(var i = 0; i < cmdList.length; i++){
		select.options.add(new Option(cmdList[i].info, i))
	}
}

function connectToRCE() {
	wsuri = document.getElementById('wsuri').value;
	console.log('connect button pressed. wsuri:='+wsuri);
	updateRobotStatus("Trying to connect ...");
	if ("WebSocket" in window) {
		webSocket = new WebSocket(wsuri);
	}else {
		//Firefox currently prefixes the WebSocket object
		webSocket = new MozWebSocket(wsuri);
	}
	webSocket.onmessage = onmessage;
	
	webSocket.onopen = function() {
		updateRobotStatus("WebSockets connection estabilised.");
		console.log('connection open.')
	};
}

function onmessage(event) {
	console.log('== Message from RCE ==');
	
	if (event.data instanceof Blob) {
		console.log('Info: received a Blob');
		var rceMsgReader = new FileReader();
		var textReader = new FileReader();
		rceMsgReader.onerror = function(event) {
			console.log('Error: Failed to read the rce message');
		};
		textReader.onload = function(event) {
			console.log('Info: UUID from RCE - '+textReader.result);
		};
		
		rceMsgReader.onload = function(event) {
			console.log('Info: loaded blob as dataURL');
			
			//now draw the image in the browser
			
			var imageDataURL = rceMsgReader.result;
			if (imageDataURL.indexOf("data:base64,") == 0){
				//mime is missing - chrome gonna complain
				imageDataURL = "data:image/png;base64," + imageDataURL.slice(12,imageDataURL.length);
				console.log('MIME is missing .. but fixed.');		
			}
			
			imageDataURL = imageDataURL.replace('application/octet-stream','image/png');
			imageObj.src = imageDataURL;
		};

		uidBlob = event.data.slice(1,32,'text')
		textReader.readAsText(uidBlob);
		imageBlob = event.data.slice(32,event.data.size,'image/png')
		rceMsgReader.readAsDataURL(imageBlob);
		
	}else{
		console.log('Info: received a non-blob');
		
		document.getElementById('receiverConsole').value = ('== Message from RCE ==\r\n' + event.data + '\r\n---\r\n\r\n') + document.getElementById('receiverConsole').value;
		//if message is a CS update container ID
		var msg = jQuery.parseJSON(event.data)
		if(msg.type == "CS"){
			 //containerID = msg.data.containerID;
			 //updateRobotStatus("Container Assigned");
			 //updateContainerID(msg.data.containerID);
		}
	}
}


function sendCommand() {
	var okToSend = true;
	var msg_json = document.getElementById('commandConsole').value;
	console.log('sendCommand() button pressed')
	try
	{
		msg = jQuery.parseJSON( msg_json );
	}
	catch(e)
	{
		raiseError("Msg is not a well-formed JSON string ");
		okToSend = false;
	}
	
	//container creation checks
	if(msg.type=="CC"){
		if(robotStatus == "Container Assigned"){
				raiseError("Robot is already assigned a container");
				okToSend = false;
		}
	}
	
	//container delete checks
	if(msg.type=="DC"){
		if(robotStatus != "Container Assigned"){
			raiseError("You can not delete a non assigned container");
			okToSend = false;
		}else{
			updateRobotStatus("Container not Assigned");
			updateContainerID('--')
		}
	}
	
	if(msg.type=="DM" || msg.type=="CN"){
		if(robotStatus != "Container Assigned"){
			raiseError("Can not send other msgs before creating a container");
			//okToSend = false;
			}
	}
	if(okToSend=true){ //Sending everything to rce now
		webSocket.send(msg_json);
		console.log('message sent.')
	}
}


function raiseError(error){
	document.getElementById('errorMsg').textContent = error;
	console.log(error)
}

function updateRobotStatus(status){
	document.getElementById('robotStatus').textContent = status;
	console.log('Robot Status: '+status);
	//robotStatus = status;
}

function clearCommandConsole(){
	document.getElementById('commandConsole').value = "";
}

function SetCommand(cmd){
	document.getElementById('commandConsole').value = cmd;
}

function clearCommand(){
	document.getElementById('commandConsole').value = "";
}

function clearErrorMsg(){
	document.getElementById('errorMsg').innerText = "--";
}

function updateContainerID(id){
	containerID = id; 
	document.getElementById('containerID').innerText = id;
}

function loadCommand(sel){
	var i = sel.options[sel.selectedIndex].value;  
	if (i == -1){ // --select to load--
		clearCommand()
	}else{
		document.getElementById('commandConsole').value = JSON.stringify(cmdList[i].cmd);
	}
	 
}


//////////////////////////////////////////////////////////////////////
/////////////////								 	//////////////////
/////////////////	   	Binary Msg Upload			//////////////////
/////////////////									//////////////////
//////////////////////////////////////////////////////////////////////

var blobToSend; 
var blobReady = false;

function sendImageMsg(){
	if(blobReady){
		//send JSON with UUID
		webSocket.send(document.getElementById('JSONImageMsg').value);
		
		//send Blob
		webSocket.send(blobToSend);
		blobReady = false;
	}else{
		console.log('Blob is not ready to send');
	}
}

function handleFileSelect(evt) {
	var files = evt.target.files; 
	//getting only the first file
	console.log(files[0].type);
	
	if (files[0].type == 'image/png'){
		console.log('Correct file type');
		var localFileReader = new FileReader();

		localFileReader.onerror = function(event) {
			console.log('Error: Failed to read the file');
		};
		localFileReader.onload = function(event) {
			console.log('Info: Local file successfully loaded');
			uuidStr = uuid();

			//load JSON with UUID into text box
			txtJSON = '{"type":"DM","dest":"containerTag01","orig":"robotUniqueID","data":{"type":"sensor_msgs/Image","msgID":"msgID_0","interfaceTag":"binary/circleIn","msg*":"'+uuidStr+'"}}';	
			document.getElementById('JSONImageMsg').value = txtJSON;		
			
			blobToSend = Blob([uuidStr, localFileReader.result]); //this fails in chromium
			blobReady = true;

		};
		
		localFileReader.readAsArrayBuffer(files[0]);
		//localFileReader.readAsDataURL(files[0]);
	}else{
		console.log('Error: Please choose a image/png file');
	}
}

function uuid() {
  var uuid = "", i, random;
  for (i = 0; i < 32; i++) {
    random = Math.random() * 16 | 0;
    uuid += (i == 12 ? 4 : (i == 16 ? (random & 3 | 8) : random)).toString(16);
  }
  return uuid;
}
</script>


</head>
<body>
<div class="mask">
	<div class="header">
		<h3>RoboEarth Cloud Engine - HTML Client</h3>
	</div>
	<div class="colleft">
		<div class="col1">
      <br>Command (JSON) <br>
			<textarea rows="10" cols="50" id='commandConsole'></textarea><br>
			<select id="cmd_list" onchange='loadCommand(this)'>
				<Option value="-1" >-- select to load --</option>
			</select>
			<br><button onclick='sendCommand(); return false'>send command</button>
			<hr>
			
      <b>Robot Status:</b> <div id='robotStatus'>Not connected</div>
      <!--<b>container ID:</b> <div id='containerID'>--</div>-->
      <b>Error:</b> <div id='errorMsg'>--</div>
      <button onclick='clearErrorMsg(); return false'>clear</button><br>
			<hr>
      <h4>Load sensor_msgs/Image</h4>
			<input type="file" id="files" name="files[]"/><br> 
			<textarea rows="5" cols="50" id='JSONImageMsg'></textarea> <br>
			<button onclick='sendImageMsg(); return false'>send sensor_msgs/Image</button> <br>
      
		</div>
		<div class="col2">
			<br>
			<textarea rows="1" cols="25" id='wsuri'></textarea>
			<button onclick='connectToRCE(); return false'>connect</button><br>
			<i>Example: ws://192.168.237.131:9000/ </i><br>
			<hr>
      <br>Cloud Engine Response (JSON)<br>
			<textarea rows="30" cols="50" id='receiverConsole'></textarea><br>
			<hr>
			<h4>sensor_msgs/Image Received</h4>
<canvas id="myCanvas"  width="640" height="480"></canvas>
		</div> 
	</div> 
	<div class="footer">
		RoboEarth: Building an Internet for robots. <br> Part of the Cognitive Systems and Robotics Initiative from the European Union Seventh Framework Programme FP7/2007-2013.
	</div>
</div>
</body>
</html>