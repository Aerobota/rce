<!DOCTYPE html>
<html>
<script type="text/javascript">
var webSocket;
var wsuri = "ws://localhost:9000/";
var canvas, context, imageObj;

window.onload = function() {
	if ("WebSocket" in window) {
		webSocket = new WebSocket(wsuri);
	}else {
		//Firefox currently prefixes the WebSocket object
		webSocket = new MozWebSocket(wsuri);
	}
	webSocket.onmessage = onmessage;
	webSocket.onopen = function() {
		console.log('Info: Websockets connection established');
	};
	
	// Check for the file API support.
	if (window.File && window.FileReader && window.FileList && window.Blob) {
  	console.log('Info: All the File APIs are supported.');
	} else {
  	console.log('Warn: The File APIs are not fully supported in this browser.');
	}
	
	//file event listener
	document.getElementById('files').addEventListener('change', handleFileSelect, false);
	
	//image canvas
	canvas = document.getElementById("myCanvas");
	context = canvas.getContext("2d");
	imageObj = new Image();
	imageObj.onload = function() {
		context.drawImage(imageObj, 0, 0);
	};
};


function onmessage(event) {
	console.log('== Message from RCE ==')
	
	if (event.data instanceof Blob) {
		console.log('Info: received a Blob');
		var rceMsgReader = new FileReader();
		var textReader = new FileReader();
		rceMsgReader.onerror = function(event) {
			console.log('Error: Failed to read the rce message');
		};
		textReader.onload = function(event) {
			console.log('Info: UUID from RCE - '+textReader.result);
		};
		
		rceMsgReader.onload = function(event) {
			console.log('Info: loaded blob as dataURL');
			
			//now draw the image in the browser
			
			var imageDataURL = rceMsgReader.result;
			if (imageDataURL.indexOf("data:base64,") == 0){
				//mime is missing - chrome gonna complain
				imageDataURL = "data:image/png;base64," + imageDataURL.slice(12,imageDataURL.length);
				console.log('MIME is missing .. but fixed.');		
			}
			
			imageDataURL = imageDataURL.replace('application/octet-stream','image/png');
			imageObj.src = imageDataURL;
		};

		uidBlob = event.data.slice(1,32,'text')
		textReader.readAsText(uidBlob);
		imageBlob = event.data.slice(32,event.data.size,'image/png')
		rceMsgReader.readAsDataURL(imageBlob);
		
	}else{
		console.log('Info: received a non-blob');
		
		}
	}
};


var blobToSend; 
var blobReady = false;

function sendImageMsg(){
	if(blobReady){
		//send JSON with UUID
		webSocket.send(document.getElementById('JSONImageMsg').value);
		
		//send Blob
		webSocket.send(blobToSend);
		blobReady = False;
	}else{
		console.log('Blob is not ready to send');
	}
}

function handleFileSelect(evt) {
	var files = evt.target.files; 
	//getting only the first file
	console.log(files[0].type);
	
	if (files[0].type == 'image/png'){
		console.log('Correct file type');
		var localFileReader = new FileReader();

		localFileReader.onerror = function(event) {
			console.log('Error: Failed to read the file');
		};
		localFileReader.onload = function(event) {
			console.log('Info: Local file successfully loaded');
			uuidStr = uuid();

			//load JSON with UUID into text box
			txtJSON = '{"type":"CM","dest":"containerTag01","orig":"robotUniqueID","data":{"type":"sensor_msgs/Image","msgID":"msgID_0","interfaceTag":"Test/modifyImage","msg":{"data":'+uuidStr+'}}}';	
			document.getElementById('JSONImageMsg').value = txtJSON;		
			
			blobToSend = Blob([uuidStr, localFileReader.result]); //this fails in chromium
			//webSocket.send(localFileReader.result); //to just send the file
			//webSocket.send(b);
			blobReady = true;
			console.log('Info: '+localFileReader.result.byteLength+' bytes of data sent to rce')
		};
		
		localFileReader.readAsArrayBuffer(files[0]);
		//localFileReader.readAsDataURL(files[0]);
	}else{
		console.log('Error: Please choose a image/png file');
	}
}

function uuid() {
  var uuid = "", i, random;
  for (i = 0; i < 32; i++) {
    random = Math.random() * 16 | 0;

//    if (i == 8 || i == 12 || i == 16 || i == 20) {
//      uuid += "-"
//    }
    uuid += (i == 12 ? 4 : (i == 16 ? (random & 3 | 8) : random)).toString(16);
  }
  return uuid;
}

</script>

<body>

<br>---------------------------<br>
<input type="file" id="files" name="files[]"/><br> 
<textarea rows="5" cols="40" id='JSONImageMsg'></textarea> <br>
<button onclick='sendImageMsg(); return false'>send sensor_msgs/Image</button> <br>
<br>---------------------------<br>
Retreived image:<br>
<canvas id="myCanvas"  width="640" height="480"></canvas>
</body>
</html>

